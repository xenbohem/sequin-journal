<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Fairy Journal â€” Locked Drawer + Book Home</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --card-w: 380px;
    --card-h: 560px;
    --panel-cols: 10;
    --panel-rows: 14;
    --total-pages: 500;
    --drawer-w: 340px;
    --brass: #b7852f;
    --paper-edge: rgba(240,230,220,0.7);
  }

  html,body{height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
  body{
    background: radial-gradient(circle at 10% 10%, #12061a 0%, #0b0410 40%), #08030a;
    display:flex; align-items:center; justify-content:center; padding:36px; box-sizing:border-box; overflow:hidden;
  }

  .stage{ display:flex; gap:20px; align-items:center; }

  /* CARD */
  .fantasy-card{
    width:var(--card-w); height:var(--card-h); border-radius:28px; padding:20px; position:relative;
    background: linear-gradient(145deg,#3b1761,#1b0f33); box-shadow:0 20px 60px rgba(140,80,255,0.25);
    display:grid; grid-template-rows:auto 1fr auto; z-index:20;
  }
  .fantasy-card::before,.fantasy-card::after{ content:""; position:absolute; width:100%; height:48px; left:0;
    background: radial-gradient(circle at 10% 50%, rgba(255,255,255,0.18), transparent 55%), radial-gradient(circle at 90% 50%, rgba(180,140,255,0.12), transparent 55%); }
  .fantasy-card::before{ top:0; border-top-left-radius:28px; border-top-right-radius:28px;}
  .fantasy-card::after{ bottom:0; border-bottom-left-radius:28px; border-bottom-right-radius:28px;}
  .card-title{ text-align:center; font-size:1.5rem; color:#f6e9ff; text-shadow:0 0 8px rgba(200,160,255,0.6); pointer-events:none; padding-bottom:6px; }

  /* SEQUIN PANEL */
  .panel { border-radius:18px; display:grid; grid-template-columns: repeat(var(--panel-cols),1fr);
    grid-template-rows: repeat(var(--panel-rows),1fr); gap:6px; padding:14px;
    background: radial-gradient(circle at 20% 10%, rgba(255,255,255,0.18), transparent 40%), radial-gradient(circle at 80% 30%, rgba(255,255,180,0.12), transparent 40%), linear-gradient(135deg,#4d2a7f,#1b0f33); background-blend-mode:screen; align-self:center; box-shadow: inset 0 2px 12px rgba(0,0,0,0.35); }
  .sequin{ width:100%; height:100%; border-radius:50%; position:relative; cursor:pointer; transition:transform .2s ease, background .22s ease;
    background: radial-gradient(circle at 30% 30%, #c488ff, #8946d8 60%, #3b165d 100%); }
  .sequin.flipped{ background: radial-gradient(circle at 70% 70%, #5a61ff,#3237a0 60%,#141852 100%); }
  .sequin::after{ content:""; position:absolute; inset:0; border-radius:50%;
    background: radial-gradient(circle at 25% 25%, rgba(255,255,255,0.85), transparent 40%), radial-gradient(circle at 65% 70%, rgba(255,255,255,0.36), transparent 60%);
    mix-blend-mode:screen; opacity:.7; pointer-events:none; }

  /* sparkles */
  .sparkle{ position:fixed; width:6px; height:6px; border-radius:50%; background: radial-gradient(circle, rgba(255,255,255,1) 30%, rgba(255,255,255,0.05) 70%);
    pointer-events:none; transform:translate(-50%,-50%); z-index:1000; filter:drop-shadow(0 0 6px rgba(255,255,255,.9)); animation: sparkle-fade 1.4s ease-out forwards; }
  @keyframes sparkle-fade{ 0%{ opacity:1; transform:translate(-50%,-50%) scale(1);} 100%{ opacity:0; transform:translate(-50%,-120%) scale(1.6);} }

  /* drawer area (right) */
  .drawer-wrap{ width:var(--drawer-w); height:var(--card-h); position:relative; display:flex; align-items:center; justify-content:flex-start; pointer-events:none; }
  /* lock hinge always visible and attached to card edge */
  .lock-hinge{ position:absolute; right: calc(var(--drawer-w) - 20px); top: calc(50% - 22px); width:40px; height:44px; transform-origin:left center; z-index:40; pointer-events:auto; }
  .lock-button{ position:relative; left:6px; width:34px; height:34px; cursor:pointer; display:flex; align-items:center; justify-content:center; transform-origin:center; transition:transform .28s cubic-bezier(.2,.9,.1,1); }
  .lock-chain{ position:absolute; left:10px; top:-22px; width:2px; height:18px; background: linear-gradient(#cfa95b,#8a5f23); transform-origin:top center; border-radius:1px; }
  .lock-body{ width:24px; height:22px; border-radius:5px; background:linear-gradient(#d3a95a,#b07d2a); border:1px solid rgba(0,0,0,0.18); box-shadow: inset 0 -3px 6px rgba(0,0,0,0.15), 0 3px 8px rgba(0,0,0,0.25); position:relative; }
  .lock-body::before{ content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-30%); width:8px; height:10px; background:linear-gradient(#2b1808,#1b0f07); border-radius:2px; box-shadow: inset 0 1px rgba(255,255,255,0.05); }
  .lock-shackle{ position:absolute; left:50%; top:-10px; transform:translateX(-50%); width:18px; height:14px; border:3px solid var(--brass); border-bottom:none; border-radius:14px 14px 0 0; background:transparent; }
  .lock-open .lock-button{ transform: rotate(22deg) translate(4px,-2px); }
  .lock-open .lock-chain{ transform: rotate(20deg) translateY(6px); }

  /* drawer is fully hidden and non-interactive until unlocked */
  .drawer{ position:absolute; right:0; top:0; width:var(--drawer-w); height:100%; background: linear-gradient(180deg,#fff,#fff); transform: translateX(calc(100%)); transition: transform .42s cubic-bezier(.22,.98,.35,1), box-shadow .3s, opacity .28s; border-radius:12px; box-shadow:0 20px 60px rgba(10,6,12,0.45); pointer-events:none; z-index:30; opacity:0; }
  .drawer.open{ transform: translateX(0); box-shadow:0 25px 90px rgba(10,6,12,0.6); opacity:1; pointer-events:auto; }

  .drawer-inner{ height:100%; padding:18px; box-sizing:border-box; display:flex; flex-direction:column; gap:10px; background: linear-gradient(180deg, rgba(250,250,250,0.98), rgba(250,248,244,0.98)); }

  .drawer-top{ display:flex; gap:8px; align-items:center; justify-content:space-between; }

  .page-stack{ width:68px; height:100%; position:relative; border-radius:8px; background: linear-gradient(180deg,#fcfbf8,#f6f2ee); box-shadow: inset 0 0 0 1px rgba(200,190,180,0.15), 0 6px 18px rgba(0,0,0,0.15); overflow:hidden; flex:0 0 68px; }
  .page-stack::before{ content:""; position:absolute; left:8px; top:8px; right:8px; bottom:8px; background: repeating-linear-gradient(180deg, rgba(230,220,210,0.6) 0 1px, transparent 1px 6px); opacity:0.6; filter: blur(0.2px); }

  .page-area{ flex:1; padding:12px; display:flex; flex-direction:column; gap:8px; overflow:auto; }

  .page{ background: linear-gradient(180deg,#fff,#fff); border-radius:10px; padding:16px; box-shadow: 0 6px 22px rgba(20,10,20,0.06); min-height:220px; max-width:540px; width:100%; border:1px solid rgba(200,190,180,0.18); box-sizing:border-box; position:relative; }
  .page.vintage{ box-shadow: 0 8px 22px rgba(30,14,50,0.06), inset 0 0 0 1px rgba(220,210,195,0.18); }
  .page.vintage::after{ content:""; position:absolute; left:6px; right:6px; bottom:8px; height:12px; background: linear-gradient(180deg, rgba(250,246,240,0.95), rgba(245,240,230,0.4)); border-radius:6px; pointer-events:none; opacity:.8; }

  .date-row{ display:flex; gap:10px; align-items:center; margin-bottom:8px; }
  .page input[type="date"], .page input[type="text"]{ width:220px; padding:6px 8px; border-radius:6px; border:1px solid rgba(120,110,130,0.12); background: linear-gradient(180deg,#fff,#fdfbf9); font-size:14px; }
  .page input.title{ width:100%; font-weight:600; padding:8px; }

  .page textarea{ width:100%; min-height:180px; resize:vertical; padding:10px; border-radius:8px; border:1px solid rgba(140,120,140,0.08); font-size:14px; line-height:1.45; background: linear-gradient(180deg,#fff,#fff); box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); }

  .page-controls{ display:flex; gap:8px; align-items:center; justify-content:flex-end; padding-top:6px; }
  .btn{ background:linear-gradient(180deg,#fff,#f6f3ee); border:1px solid rgba(180,170,160,0.2); padding:8px 10px; border-radius:8px; cursor:pointer; font-size:13px; }
  .btn.secondary{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:#fff; }

  .page-footer{ display:flex; justify-content:space-between; align-items:center; gap:8px; font-size:13px; color:#5c5260; padding-top:6px; }

  /* date index list */
  .date-index{ display:flex; flex-direction:column; gap:6px; max-height:120px; overflow:auto; padding:6px; border-radius:8px; background:linear-gradient(180deg, rgba(250,250,255,0.6), rgba(250,250,250,0.4)); }
  .date-item{ padding:6px 8px; border-radius:6px; background:transparent; cursor:pointer; font-size:13px; color:#2b2140; border:1px solid rgba(0,0,0,0.04); }
  .date-item:hover{ background: rgba(120,90,200,0.08); }

  /* password modal */
  .pw-overlay{ position:fixed; left:0; top:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; z-index:100000; background: rgba(4,4,6,0.45); opacity:0; pointer-events:none; transition:opacity .18s; }
  .pw-overlay.open{ opacity:1; pointer-events:auto; }
  .pw-box{ background:linear-gradient(180deg,#0f0620,#210a37); padding:18px; border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.6); color:#fff; width:320px; text-align:center; border:1px solid rgba(255,255,255,0.04); }
  .pw-box h3{ margin:0 0 8px 0; font-weight:600; }
  .pw-input{ margin-top:8px; display:flex; gap:8px; justify-content:center; }
  .pw-input input{ width:160px; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.04); color:#fff; text-transform:none; letter-spacing:2px; font-size:16px; text-align:center; }
  .pw-error{ margin-top:8px; color:#ffb4c4; height:18px; font-size:13px; opacity:0; transition:opacity .18s; }
  .pw-error.show{ opacity:1; }

  /* shake animation */
  @keyframes shakeX { 0%{ transform: translateX(0);} 20%{ transform: translateX(-8px);} 40%{ transform: translateX(8px);} 60%{ transform: translateX(-6px);} 80%{ transform: translateX(6px);} 100%{ transform: translateX(0);} }

  .pw-box.shake{ animation: shakeX .44s cubic-bezier(.36,.07,.19,.97); }

  /* bottom-left book icon */
  .book-home{ position:fixed; left:18px; bottom:18px; width:56px; height:56px; background: linear-gradient(180deg,#f2e9ff,#e7dcff); border-radius:12px; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(80,48,140,0.28); cursor:pointer; z-index:1000; }
  .book-home .icon{ width:34px; height:34px; background: linear-gradient(180deg,#d9b7ff,#b88bff); border-radius:6px; box-shadow: inset 0 1px rgba(255,255,255,0.4); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:18px; }
  .book-home:hover{ transform: translateY(-4px); transition:transform .18s; }
</style>
</head>
<body>
  <div class="stage">
    <div class="fantasy-card" id="card">
      <div class="card-title">âœ¨ My Fairy Journal âœ¨</div>
      <div class="panel" id="panel"></div>
    </div>

    <div class="drawer-wrap">
      <div class="lock-hinge" id="lockHinge" role="button" aria-label="Open journal drawer" title="Click lock">
        <div class="lock-chain"></div>
        <div class="lock-button" id="lockBtn">
          <div class="lock-body" aria-hidden="true"></div>
          <div class="lock-shackle" aria-hidden="true"></div>
        </div>
      </div>

      <div class="drawer" id="drawer" aria-hidden="true">
        <div class="drawer-inner">
          <div class="drawer-top">
            <div style="display:flex;flex-direction:column">
              <div style="font-size:13px;color:#6b5a66">Date Index</div>
              <div id="dateIndex" class="date-index" aria-live="polite"></div>
            </div>

            <div style="display:flex;gap:8px;align-items:center;">
              <div style="font-size:13px;color:#5c5260">Pages <strong id="pageCountSpan">0/0</strong></div>
              <button class="btn" id="closeDrawerBtn" title="Close drawer">Close</button>
            </div>
          </div>

          <div style="display:flex; gap:12px; align-items:stretch; flex:1;">
            <div class="page-stack" aria-hidden="true"></div>
            <div class="page-area" id="pageArea"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- password modal -->
  <div class="pw-overlay" id="pwOverlay" aria-hidden="true">
    <div class="pw-box" id="pwBox" role="dialog" aria-modal="true" aria-label="Enter password to open drawer">
      <h3>Unlock Journal Drawer</h3>
      <div style="font-size:13px;color:#cfc0f0">Enter your 4-letter passcode</div>
      <div class="pw-input" style="margin-top:10px;">
        <input id="pwInput" placeholder="----" maxlength="16" autofocus />
      </div>
      <div style="margin-top:8px; display:flex; gap:8px; justify-content:center;">
        <button class="btn" id="pwOk">Unlock</button>
        <button class="btn secondary" id="pwCancel">Cancel</button>
      </div>
      <div class="pw-error" id="pwError">Incorrect passcode</div>
    </div>
  </div>

  <!-- book home icon -->
  <div class="book-home" id="bookHome" title="Return to cover">
    <div class="icon">ðŸ“–</div>
  </div>

<script>
/* ---------- Sequins + Sparkles (unchanged interaction) ---------- */
const panel = document.getElementById('panel');
const cols = 10, rows = 14;
const totalSequins = cols * rows;
for(let i=0;i<totalSequins;i++){
  const s = document.createElement('div');
  s.className = 'sequin';
  panel.appendChild(s);
}
let isDragging = false;
let lastX = null;
function updateSequin(el, dx){
  if(dx === 0) el.classList.toggle('flipped');
  else if(dx > 0) el.classList.add('flipped');
  else el.classList.remove('flipped');
}
function createSparkle(x,y){
  const sp = document.createElement('div');
  sp.className = 'sparkle';
  sp.style.left = x + 'px';
  sp.style.top = y + 'px';
  document.body.appendChild(sp);
  setTimeout(()=> sp.remove(), 1500);
}
let sparkleCooldown = 0;
panel.addEventListener('pointerdown', e => {
  isDragging = true;
  lastX = e.clientX;
  Array.from(panel.children).forEach(s=>{
    const r = s.getBoundingClientRect();
    if(e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom){
      updateSequin(s, 0);
    }
  });
});
panel.addEventListener('pointerup', ()=> { isDragging=false; lastX=null; });
panel.addEventListener('pointerleave', ()=> { isDragging=false; lastX=null; });
panel.addEventListener('pointermove', e => {
  if(!isDragging) return;
  const dx = e.clientX - lastX; lastX = e.clientX;
  Array.from(panel.children).forEach(s=>{
    const r = s.getBoundingClientRect();
    if(e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom){
      updateSequin(s, dx);
    }
  });
  const now = performance.now();
  if(now - sparkleCooldown > 40){
    createSparkle(e.clientX, e.clientY);
    sparkleCooldown = now;
  }
});

/* ---------- Drawer, Lock, Password, Pages, Date Index ---------- */
const lockBtn = document.getElementById('lockBtn');
const lockHinge = document.getElementById('lockHinge');
const drawer = document.getElementById('drawer');
const pageArea = document.getElementById('pageArea');
const pageCountSpan = document.getElementById('pageCountSpan');
const closeDrawerBtn = document.getElementById('closeDrawerBtn');
const dateIndex = document.getElementById('dateIndex');

const PAGES = Number(getComputedStyle(document.documentElement).getPropertyValue('--total-pages')) || 500;
pageCountSpan.textContent = `1/${PAGES}`;

/* pages storage */
const STORAGE_KEY = 'fairy_journal_pages_v1';
let pages = new Array(PAGES).fill(null);
try{
  const saved = localStorage.getItem(STORAGE_KEY);
  if(saved){
    const parsed = JSON.parse(saved);
    if(Array.isArray(parsed) && parsed.length === PAGES) pages = parsed;
  }
}catch(e){ console.warn('restore failed', e); }

/* drawer state */
let drawerOpen = false;
let currentPageIndex = 0;

/* password modal references */
const pwOverlay = document.getElementById('pwOverlay');
const pwBox = document.getElementById('pwBox');
const pwInput = document.getElementById('pwInput');
const pwOk = document.getElementById('pwOk');
const pwCancel = document.getElementById('pwCancel');
const pwError = document.getElementById('pwError');

/* book home */
const bookHome = document.getElementById('bookHome');

/* Helper: open/close drawer (only after unlocking) */
function setLockOpen(open){
  drawerOpen = open;
  drawer.classList.toggle('open', open);
  lockHinge.classList.toggle('lock-open', open);
  drawer.setAttribute('aria-hidden', !open);
  if(open) renderPage(currentPageIndex);
  // when closing, reset password state
  if(!open){
    hidePassword();
  }
}

/* show password modal (triggered by clicking lock) */
function showPassword(){
  pwOverlay.classList.add('open');
  pwOverlay.setAttribute('aria-hidden','false');
  pwInput.value = '';
  pwError.classList.remove('show');
  pwBox.classList.remove('shake');
  setTimeout(()=> pwInput.focus(),120);
}

/* hide modal */
function hidePassword(){
  pwOverlay.classList.remove('open');
  pwOverlay.setAttribute('aria-hidden','true');
}

/* on lock clicked: show password prompt */
lockBtn.addEventListener('click', (ev)=>{
  ev.stopPropagation();
  showPassword();
});

/* Cancel password */
pwCancel.addEventListener('click', hidePassword);

/* password check (accept 'key', case-insensitive) */
function checkPassword(raw){
  if(!raw) return false;
  const trimmed = raw.trim().toLowerCase();
  // accept 'key' or 'key!' or 'key ' - primary secret is 'key'
  return trimmed === 'key' || trimmed === 'key!' || trimmed === 'key.';
}

/* on OK: validate and open */
pwOk.addEventListener('click', ()=> {
  const val = pwInput.value || '';
  if(checkPassword(val)){
    pwError.classList.remove('show');
    pwBox.classList.remove('shake');
    hidePassword();
    setTimeout(()=> setLockOpen(true), 180);
  } else {
    pwError.classList.add('show'); pwBox.classList.add('shake');
    setTimeout(()=> pwBox.classList.remove('shake'), 480);
  }
});

/* allow Enter key submission in input */
pwInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') pwOk.click();
  if(e.key === 'Escape') pwCancel.click();
});

/* clicking outside while open closes */
document.addEventListener('click', (e)=>{
  if(!drawerOpen) return;
  const withinDrawer = drawer.contains(e.target) || lockHinge.contains(e.target);
  if(!withinDrawer) setLockOpen(false);
});

/* Close drawer button */
closeDrawerBtn.addEventListener('click', ()=> setLockOpen(false));

/* Book home icon behavior (always visible bottom-left) */
bookHome.addEventListener('click', ()=>{
  // close drawer and focus back on cover
  setLockOpen(false);
  // subtle feedback: tiny bounce
  bookHome.animate([{ transform: 'translateY(0)' }, { transform: 'translateY(-6px)' }, { transform: 'translateY(0)' }], { duration: 340, easing: 'ease-out' });
});

/* Render page UI for a page index */
function renderPage(index){
  currentPageIndex = Math.max(0, Math.min(PAGES-1, index));
  pageCountSpan.textContent = `${currentPageIndex+1}/${PAGES}`;
  if(!pages[currentPageIndex]) pages[currentPageIndex] = { date: new Date().toISOString().slice(0,10), title:'', body:'' };
  // build page DOM
  pageArea.innerHTML = '';
  const pageWrap = document.createElement('div'); pageWrap.className = 'page vintage';

  // date row with clickable "Go to date" hint
  const dateRow = document.createElement('div'); dateRow.className = 'date-row';
  const dateLabel = document.createElement('label'); dateLabel.textContent = 'Date';
  const dateInput = document.createElement('input'); dateInput.type = 'date';
  dateInput.value = pages[currentPageIndex].date || new Date().toISOString().slice(0,10);
  dateInput.addEventListener('change', ()=> { pages[currentPageIndex].date = dateInput.value; savePages(); refreshDateIndex(); });
  dateRow.appendChild(dateLabel); dateRow.appendChild(dateInput);

  // small "jump to previous by date" link
  const prevByDateBtn = document.createElement('button'); prevByDateBtn.className = 'btn secondary'; prevByDateBtn.style.marginLeft='8px'; prevByDateBtn.textContent = 'Find by Date';
  prevByDateBtn.title = 'Jump to an entry from a specific date';
  prevByDateBtn.addEventListener('click', ()=> {
    // show a prompt to enter a date to jump to (quick fallback)
    const d = prompt('Enter date to find (YYYY-MM-DD):', dateInput.value || '');
    if(!d) return;
    const found = pages.findIndex(p => p && p.date === d);
    if(found >= 0) renderPage(found);
    else alert('No entry found for that date.');
  });
  dateRow.appendChild(prevByDateBtn);

  // title input
  const titleInput = document.createElement('input'); titleInput.type='text'; titleInput.placeholder='Entry title'; titleInput.className='title';
  titleInput.value = pages[currentPageIndex].title || '';
  titleInput.addEventListener('input', ()=> { pages[currentPageIndex].title = titleInput.value; savePages(); refreshDateIndex(); });

  // textarea
  const ta = document.createElement('textarea'); ta.placeholder='Write your thoughts...'; ta.value = pages[currentPageIndex].body || '';
  ta.addEventListener('input', ()=> { pages[currentPageIndex].body = ta.value; savePages(); });

  // controls row
  const controls = document.createElement('div'); controls.className = 'page-controls';
  const prevBtn = document.createElement('button'); prevBtn.className='btn'; prevBtn.textContent='â† Prev'; prevBtn.addEventListener('click', ()=> renderPage(currentPageIndex-1));
  const nextBtn = document.createElement('button'); nextBtn.className='btn'; nextBtn.textContent='Next â†’'; nextBtn.addEventListener('click', ()=> renderPage(currentPageIndex+1));
  const jumpInput = document.createElement('input'); jumpInput.type='number'; jumpInput.min=1; jumpInput.max=PAGES; jumpInput.value=currentPageIndex+1; jumpInput.style.width='70px';
  jumpInput.addEventListener('change', ()=> { const v = Math.max(1, Math.min(PAGES, Number(jumpInput.value) || 1)); renderPage(v-1); });
  const saveBtn = document.createElement('button'); saveBtn.className='btn'; saveBtn.textContent='Save'; saveBtn.addEventListener('click', ()=> { savePages(); saveFeedback(); });

  controls.appendChild(prevBtn); controls.appendChild(nextBtn); controls.appendChild(jumpInput); controls.appendChild(saveBtn);

  // footer
  const footer = document.createElement('div'); footer.className='page-footer';
  footer.innerHTML = `<div>Page ${currentPageIndex+1} of ${PAGES}</div><div style="font-size:13px;color:#6b5a66">Vintage â€¢ Slight cream edge</div>`;

  pageWrap.appendChild(dateRow);
  pageWrap.appendChild(titleInput);
  pageWrap.appendChild(ta);
  pageArea.appendChild(pageWrap);
  pageArea.appendChild(controls);
  pageArea.appendChild(footer);

  // focus textarea lightly
  setTimeout(()=> ta.focus(), 60);
  refreshDateIndex(); // update date list highlight
}

/* save to localStorage */
function savePages(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(pages)); }catch(e){ console.warn('save failed', e); }
}

/* visual save feedback */
function saveFeedback(){
  const stack = document.querySelector('.page-stack');
  stack.style.boxShadow = 'inset 0 0 0 2px rgba(180,130,255,0.18)';
  setTimeout(()=> stack.style.boxShadow = 'inset 0 0 0 1px rgba(200,190,180,0.15), 0 6px 18px rgba(0,0,0,0.15)', 400);
}

/* build date index from pages (unique, sorted newest-first) */
function getSavedDates(){
  const map = {};
  pages.forEach((p,i)=> { if(p && p.date) { if(!map[p.date]) map[p.date]=i; } });
  // create sorted array of {date,index}
  return Object.keys(map).sort((a,b)=> b.localeCompare(a)).map(d=> ({ date: d, index: map[d] }) );
}

/* refresh date index UI */
function refreshDateIndex(){
  const list = getSavedDates();
  dateIndex.innerHTML = '';
  if(list.length === 0){
    dateIndex.innerHTML = '<div style="font-size:13px;color:#6b5a66">No saved dates yet</div>';
    return;
  }
  list.forEach(item=>{
    const el = document.createElement('div'); el.className='date-item'; el.textContent = item.date;
    el.addEventListener('click', ()=> { renderPage(item.index); });
    dateIndex.appendChild(el);
  });
}

/* initialize structure and ensure pages array length */
document.addEventListener('DOMContentLoaded', ()=>{
  if(pages.length !== PAGES){
    const newPages = new Array(PAGES).fill(null);
    for(let i=0;i<Math.min(pages.length,PAGES);i++) newPages[i] = pages[i];
    pages = newPages;
  }
  pageCountSpan.textContent = `1/${PAGES}`;
});

/* keyboard while open */
document.addEventListener('keydown', (e)=>{
  if(!drawer.classList.contains('open')) return;
  if(e.key === 'ArrowRight') renderPage(currentPageIndex+1);
  if(e.key === 'ArrowLeft') renderPage(currentPageIndex-1);
  if(e.key === 'Escape') setLockOpen(false);
});

/* setLockOpen wrapper used by password flow */
function setLockOpen(open){
  drawer.classList.toggle('open', open);
  lockHinge.classList.toggle('lock-open', open);
  drawer.setAttribute('aria-hidden', !open);
  if(open) renderPage(currentPageIndex);
  if(!open) hidePassword();
}

/* clicking outside drawer closes it */
document.addEventListener('click', (e)=>{
  if(!drawer.classList.contains('open')) return;
  const within = drawer.contains(e.target) || lockHinge.contains(e.target);
  if(!within) setLockOpen(false);
});
</script>
</body>
</html>
